# IMVU Insight — データ構造とレイヤ設計

## 1. ドキュメントの目的

本ドキュメントは、IMVU Insight プロジェクトにおけるデータ構造の全体設計方針とレイヤ分割を説明します。特に以下を明確にします。

- 各データレイヤの責務
- Raw / Core / Analytics 各レイヤで許容される振る舞いと禁止事項
- XML 生データがどのようにビジネスオブジェクトや分析結果に進化するか

この設計は以下をサポートすることを目指します：
- データインポートの追跡可能性
- ビジネスモデルの再構築可能性
- 長期的に拡張可能な分析能力

---

## 2. コア設計の結論（先に結論）

### 2.1 レイヤの原則

> Raw は厳密な「Strict Raw」とし、独立した Staging Raw レイヤは設けない。
>
>- Raw レイヤ：事実のみを扱う
>- Core レイヤ：ビジネス意味を扱う
>- Analytics レイヤ：分析・表示方法を扱う

フィールドの結合、意味推論、ビジネス抽象化はすべて Core レイヤ以降で行うこと。

---

## 3. データ全体の流れ

データの流れは次の通りです：

```text
XML ファイル
↓
data_sync_records（原本ファイル保存、バイナリ Raw）
↓
Raw テーブル（Strict Raw、XML ミラー）
↓
Core / Biz テーブル（ビジネスオブジェクト層）
↓
Analytics（ビュー / 集計テーブル）
```

---

## 4. Raw レイヤ設計原則（Strict Raw）

### 4.1 Raw レイヤの定義

Raw レイヤは XML 生データの構造化ミラーです。唯一の目的は：

> XML のすべての attribute を SQL で問い合わせ可能にすること。

Raw レイヤはビジネスの見解を表現せず、ビジネス解釈を行わない。

---

### 4.2 Raw の鉄則

#### ✅ Raw レイヤで許容されること

- XML attribute とテーブル列の 1:1 マッピング
- フィールド名は正規化可能（例：snake_case）
- XML に含まれる元の値形式を保持する（文字列／数値文字列／Y/N／空文字など）
- 技術的な列の追加を許容：
	- `sync_record_id`（ソースファイル）
	- `snapshot_date`（インポートのスナップショット日付）
	- `created_at`

#### ❌ Raw レイヤで禁止されること

- フィールドの結合（複数の金額フィールドを合成する等）
- 新たな意味フィールドの推論（例：`is_gift`、`is_active`）
- 意味の変更（例：`visible='Y'` を boolean に変える等）
- XML に存在する attribute の破棄
- ビジネス命名の使用（例：`transaction_id`、`amount`、`income`）

---

### 4.3 Raw の位置づけまとめ

> Raw は事実であり、見解ではない。

Raw が回答するのは「当時 IMVU が私に何を提供したか？」だけである。

---

## 5. `data_sync_records` の役割

既存の `data_sync_records` テーブルは以下の責務を担う：

- 元の XML ファイルを保存する（`content`）
- ファイル単位の冪等性（`hash`）
- インポートバッチと Raw データの関連付け

従って：

> `data_sync_records` は Raw ファイルメタ／バイナリ Raw と同等である。

Raw テーブルは `sync_record_id` を介して元ファイルに関連付けられる。

---

## 6. Core / Biz レイヤ設計原則

### 6.1 Core の定義

Core レイヤは Raw データに対するシステムの最初のビジネス解釈であり、次を表現するために使われる：

- 何がユーザーか
- 何が商品か
- 何がトランザクションか

Core のデータは次の性質を持つべき：
- 意味が明確であること
- 構造が安定していること
- フロントエンドやビジネスロジックで直接使えること

---

### 6.2 Core で許容されること

- フィールド結合（例：金額フィールドの統合）
- 意味推論（例：`is_gift`）
- 統一命名（例：`transaction_id`）
- 外部キー関係の構築（user / product / developer）
- 重複排除、検証、正規化

### 6.3 トレース可能性の制約

> Core レイヤのすべてのデータは Raw レイヤへトレース可能でなければならない。

Core は手作業で編集されるデータではなく、Raw から再現可能な結果層である。

---

## 7. Analytics レイヤ設計原則

### 7.1 Analytics の定義

Analytics レイヤは以下をサポートする：

- 統計分析
- トレンド分析
- ダッシュボード／可視化
- ランキング、集計、比較

### 7.2 実装方法

Analytics は次のいずれかで実装できる：

- SQL View（優先、軽量で保守しやすい）
- マテリアライズドな集計テーブル（データ量や性能要件により）

Analytics のデータは：
- 事実のソースではない
- 必要に応じて削除・再生成できる

---

## 8. ユーザーと役割の統一的認識

IMVU プラットフォーム上では：

- Developer
- Buyer
- Recipient
- Reseller

本質的にはこれらはいずれも同一カテゴリの実体、すなわち IMVU ユーザーである。
違いはビジネス文脈での役割にあるだけで、アイデンティティそのものの区別ではない。

したがって：

- Raw レイヤは各種 `user_id` の原始フィールドを保持する
- Core レイヤは `imvu_user` として統合抽象化する
- 役割の意味はビジネス関係の中で表現されるのみである

---

## 9. 設計哲学の要約

本プロジェクトのコア設計哲学：

> 事実と見解を分離する。
> 履歴と現在を分離する。
> 保存（ストレージ）と分析を分離する。

まとめると：

> Raw は「何を見たか」を担当し、
> Core は「それが何か」を担当し、
> Analytics は「どう見せたいか」を担当する。

---

## 10. 設計上のトレードオフ

本プロジェクトでは独立した Staging Raw レイヤを導入しない方針とした。理由：

- 元の XML ファイルは既に保管されている
- プロジェクトの規模・複雑度が追加レイヤを正当化しない
- 心理モデルを簡素に保ち、意味的混乱を避ける
- Raw と Core の責務を明確に保てる

将来的に要件が変われば、既存の Raw/Core を壊さずに Staging を追加できる。

---

## 11. 実装の推奨順序

1. Strict Raw テーブル定義を確定する（XML に完全に合わせる）
2. XML → Raw のパーサとインポートを実装する
3. Core のビジネステーブルを設計・実装する
4. Analytics ビューや集計テーブルを構築する
5. フロントエンドと API は Core / Analytics を利用する

---

本ドキュメントはアーキテクチャレベルの設計説明である。具体的なテーブル定義や実装詳細は該当モジュールのドキュメントとコードを参照されたい。

